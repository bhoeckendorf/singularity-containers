bootstrap: localimage
from: bh_ubuntu.sif
stage: build

%post
    apt-get update
    apt-get upgrade -y
    apt-get install -y build-essential cmake git zlib1g-dev

    mkdir /opt/src
    cd /opt/src
    git clone --branch v2.3.5 --single-branch --depth 1 https://github.com/ANTsX/ANTs.git

    mkdir ants-build
    cd ants-build

    # GIT_PROTOCOL=FALSE tricks firewall by switching git:// to https://
    cmake \
      -DBUILD_SHARED_LIBS=TRUE \
      -DBUILD_TESTING=FALSE \
      -DCMAKE_INSTALL_PREFIX=/opt/ants \
      -DSuperBuild_ANTS_USE_GIT_PROTOCOL=FALSE \
      /opt/src/ANTs
    make -j4
    cd ANTS-build
    make install



bootstrap: localimage
from: bh_ubuntu.sif
stage: final

%runscript
    exec /bin/sh "$@"

%apprun antsRegistration
    exec antsRegistration "$@"

%apprun antsApplyTransforms
    exec antsApplyTransforms "$@"

%files from build
    /opt/ants /opt/ants

%post   
    apt-get update
    apt-get upgrade -y
    apt-get install -y zlib1g

%environment
    export ANTS_HOME=/opt/ants
    export ANTSPATH=${ANTS_HOME}/bin
    export PATH=${ANTSPATH}:${PATH}
    export LD_LIBRARY_PATH=${ANTS_HOME}/lib:${LD_LIBRARY_PATH}
